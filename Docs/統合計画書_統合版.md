# AnimationTestProject → AthleticTrial (GASP) 統合計画書 【統合版】

**作成日**: 2026-01-20
**バージョン**: 4.17 (Phase 4 Step 1 Migrate 完了)
**対象環境**: Unreal Engine 5.5.4
**ステータス**: ✅ Phase 4 Step 1 Migrate 完了・Step 2 統合作業待ち

---

## 0. 本計画書について

### 0.1 統合の経緯

本計画書は、以下の2つの計画書を比較・統合したものです：

1. **IntegrationPlan_AnimationTestProject_to_AthleticTrial.md**
   - 包括的なアニメーション資産移行（140アニメ）
   - AC_Climbing コンポーネント移行
   - Motion Matching 統合手順

2. **Third Person→GASP_統合計画書.md**
   - 壁機能に特化した BP_WallTraversalComponent 化
   - GASP Parkour との競合回避設計
   - `bBlockGASPTraversal` ゲート

### 0.2 統合方針（v4.0 更新）

| 観点 | 採用する設計 | 根拠 |
|------|-------------|------|
| **母艦** | AthleticTrial (GASP) | 両計画書で一致 |
| **壁機能** | **AC_Climbing 流用・改修** | 既存91%完成のAC_Climbingを活用（工数削減） |
| **競合回避** | **bBlockGASPTraversal ゲート** | シンプルで確実 |
| **入力システム** | **既存 Input Actions / IMC を流用** | IA_ClimbUp, IA_GrabWall, IA_Release, IMC_Climbing |
| **BlendSpace** | **既存 BS を流用** | BS_Climbing (8方向) ※BS_Ledge は未作成 |
| **Enum** | **既存 Enum を流用** | E_ClimbState, E_CornerType |
| **アニメ統合** | **詳細リターゲット手順** | 140アニメを確実に移行 |
| **Motion Matching** | **PoseSearchDB 作成手順** | 詳細な手順が有用 |
| **フェーズ分け** | **計画書2ベース** + 計画書1のアニメ手順 | 最小工数・段階的検証 |

### 0.3 v4.0 主要変更点

> **重要**: v4.0 では、プロジェクト内の **全既存成果物を最大限活用** し、新規作成を最小限に抑える方針に更新。

| 項目 | v3.0 (旧) | v4.0 (新) |
|------|-----------|-----------|
| 壁機能 | AC_Climbing 改修 | **AC_Climbing 改修**（継続） |
| 入力アクション | IA_ClimbAttach 新規作成 | **既存 IA_GrabWall を流用**（設定変更のみ） |
| Input Mapping | 新規作成前提 | **IMC_Climbing を流用**（Eキー追加のみ） |
| BlendSpace | 作成済み認識 | **BS_Climbing を直接 Migrate**、**BS_Ledge は新規作成要** |
| Enum | 作成済み認識 | **E_ClimbState, E_CornerType を直接 Migrate** |
| アニメーション | 140 個リターゲット | **140 個リターゲット**（継続） |
| ドキュメント | 参照のみ | **移行ガイドとして活用** |

### 0.4 流用可能な既存成果物一覧

#### コア機能（直接 Migrate）
| 成果物 | 種別 | 完成度 | 流用方法 |
|--------|------|--------|----------|
| **AC_Climbing** | ActorComponent | 91% | 改修後 Migrate |
| **E_ClimbState** | Enum | 100% | 直接 Migrate |
| **E_CornerType** | Enum | 100% | 直接 Migrate |
| **BS_Climbing** | BlendSpace 2D | 100% | 直接 Migrate |
| **BS_Ledge** | BlendSpace 2D | **未作成** | **新規作成が必要** |

#### 高度機能（AC_Climbing 内に実装済み）
| 機能 | 完成度 | 主要関数 | 流用方法 |
|------|--------|---------|----------|
| **壁頂上立ち（Ledge Climb Up）** | 70% | StartClimbUpTop, IsAtClimbTop, OnClimbUpFinished | AC_Climbing と一緒に Migrate |
| **内壁コーナー移動** | 60% | CheckInnerCorner, CheckCornerByDistance, SwitchToNextWall | AC_Climbing と一緒に Migrate |
| **外壁コーナー移動** | 65% | CheckOuterCornerByDistance, DetectNextWall | **現時点で除外**（bEnableOuterCorner=false で無効化） |

#### 入力システム（流用・再構成）
| 成果物 | 種別 | 用途 | 流用方法 |
|--------|------|------|----------|
| **IA_GrabWall** | Input Action | 壁吸着トリガー | **E キーにリマップして流用** |
| **IA_ClimbUp** | Input Action | 上方向移動 | W キーと併用可能 |
| **IA_Release** | Input Action | 壁からの解放 | E トグル対応に変更 |
| **IMC_Climbing** | Input Mapping Context | クライミング中の入力 | 設定調整で流用 |
| **IMC_Default** | Input Mapping Context | 地上移動の入力 | そのまま流用 |

#### アニメーション資産（リターゲット後に利用）
| 成果物 | 数量 | 内容 |
|--------|------|------|
| **FreeAnimationLibrary** | 133 個 | ロコモーション、アクション系（21カテゴリ） |
| **FreeSampleAnimationSet** | 182 個 | サンプルアニメーション（15カテゴリ） |
| **AM_ClimbUp_At_Top** | 1 個 | レッジ登り上げモンタージュ（FreeAnimationLibrary/Climbing_Animations/WallGrab_unGrab/内） |

#### ドキュメント（参照・ガイドとして活用）
| ドキュメント | 内容 | 活用方法 |
|--------------|------|----------|
| `ClimbingSystem_DetailedDesign.md` | AC_Climbing 設計書 | 改修時の参照 |
| `ClimbingSystem_BugAnalysis_*.md` | バグ分析レポート | 既知問題の把握 |
| `Phase3_CharacterIntegration_TODO.md` | 統合 TODO | 作業チェックリスト |
| `検討・議事録/WallClimbing_*.md` | 議事録・検討記録 | 設計判断の経緯確認 |

---

## 1. 目的

* AnimationTestProject で開発済みの **壁吸着＋壁移動（上下左右）** を GASP と共存させる
* **FreeAnimationLibrary (133個)** と **FreeSampleAnimationSet (182個)** を GASP の Motion Matching に統合
* 競合（同時起動・アニメ/移動の食い違い）を避けつつ、統合作業を資産化

---

## 2. 統合方針（最重要）

### 2.1 採用アーキテクチャ

* **GASP (AthleticTrial) を母艦**にする（GASP側の成立条件を崩さない）
* 壁機能は **既存の AC_Climbing を改修**し、GASPキャラへ搭載

### 2.2 機能分担

| 機能 | 担当システム | 変更 |
|------|-------------|------|
| 地上ロコモーション | GASP Motion Matching | 変更しない |
| Parkour（vault/ledge等） | GASP Traversal | 使用する |
| 壁機能（吸着・上下左右移動） | **AC_Climbing（改修）** | 改修後に Migrate |
| 壁ジャンプ | — | 実装しない |
| 追加アニメーション（140個） | Motion Matching 統合 | リターゲット後に追加 |

### 2.3 AC_Climbing 既存実装の活用

AC_Climbing は既に **91%完成** しており、以下の機能が実装済み：

| 機能 | 状態 | 完成度 | 備考 |
|------|------|--------|------|
| 壁検知（LineTrace） | ✅ 実装済み | 100% | CheckForClimbableSurface |
| 壁吸着・補間処理 | ✅ 実装済み | 100% | AttachToWall, UpdateWallAttachment |
| 8方向移動 | ✅ 実装済み | 100% | UpdateClimbMovement |
| **壁頂上立ち（Ledge Climb Up）** | ✅ 実装済み | **70%** | StartClimbUpTop, IsAtClimbTop, AM_ClimbUp_At_Top |
| **内壁コーナー移動** | ✅ 実装済み | **60%** | CheckInnerCorner, CheckCornerByDistance, SwitchToNextWall |
| 外壁コーナー移動 | ⏸️ 一時除外 | 65% | CheckOuterCornerByDistance, DetectNextWall（bEnableOuterCorner=false で無効化） |
| レッジクライミング | ✅ 実装済み | 70% | Ledge系関数群 |
| Input統合 | ✅ 実装済み | 100% | IMC_Climbing, IMC_Default 切替 |
| BlendSpace | ✅ 作成済み | **50%** | BS_Climbing のみ (**BS_Ledge は未作成**) |
| Animation連携 | ⚠️ 未実装 | 0% | UpdateAnimationParameters 要実装 |
| GASP競合ゲート | ❌ 未実装 | 0% | IsClimbingActive(), bBlockGASPTraversal 要追加 |

### 2.4 壁頂上立ち（Ledge Climb Up）詳細

**概要**: 壁の頂上（レッジ）に到達した際に、壁の上に立ち上がる機能

#### 実装済み関数・変数

| 項目 | 名称 | 説明 |
|------|------|------|
| 関数 | **StartClimbUpTop()** | 壁頂上登り切り開始 |
| 関数 | **IsAtClimbTop()** | 頂上到達判定（Head位置からLineTrace） |
| 関数 | **OnClimbUpFinished()** | 登り切りアニメ終了後処理 |
| 変数 | bIsClimbingUp | 登り切り中フラグ |
| 変数 | bIsAtClimbTop | 頂上到達フラグ |
| 変数 | ClimbUpTargetLocation | 登り切り目標位置 |
| 変数 | ClimbUpMontage | 登り切りアニメーション参照 |

#### 動作フロー

```
IsAtClimbTop() で頂上検知（壁が途切れた）
  ↓
IA_ClimbUp 入力を待機
  ↓
StartClimbUpTop() → AM_ClimbUp_At_Top 再生
  ↓
OnClimbUpFinished() → 目標位置へ移動 → StopClimbing()
```

#### 使用アセット

| アセット | 種別 | ステータス |
|---------|------|----------|
| **AM_ClimbUp_At_Top** | Animation Montage | ✅ 作成済み・流用可能 |

### 2.5 内壁コーナー移動（Inner Corner Transition）詳細

**概要**: 壁の内側コーナー（凹角、90度以上の角）での移動・遷移機能

#### 実装済み関数・変数

| 項目 | 名称 | 説明 |
|------|------|------|
| 関数 | **CheckInnerCorner()** | 内壁コーナー検知 |
| 関数 | **CheckCornerByDistance()** | 距離ベース内コーナー判定 |
| 関数 | **SwitchToNextWall()** | 次の壁への遷移実行 |
| 変数 | bIsCornerDetected | コーナー検知フラグ |
| 変数 | CornerType | E_CornerType（None/Outer/Inner） |
| 変数 | NextWallNormal | 次の壁の法線ベクトル |
| 変数 | NextWallHitLocation | 次の壁での吸着位置 |
| 変数 | CornerDetectionDistance | 内コーナー検知距離 |
| 変数 | CornerTransitionThreshold | 遷移判定閾値 |

#### 動作フロー

```
UpdateClimbMovement() 中
  ↓
移動方向へ Line Trace
  ↓
HIT時: CheckCornerByDistance(MoveDirection)
  ↓
法線変化量をチェック（Dot Product < 0.7 = 内壁コーナー）
  ↓
SwitchToNextWall() → 次の壁へ滑らかに遷移
```

#### 使用アセット

| アセット | 種別 | ステータス |
|---------|------|----------|
| **E_CornerType** | Enum | ✅ 作成済み・流用可能 |

---

## 3. 競合回避ポリシー

### 3.1 入力割当

| キー | 機能 | 優先度 |
|------|------|--------|
| **Space** | GASP Parkour / Jump | 標準 |
| **E** | 壁吸着トグル（Attach/Exit） | 壁前提時のみ |
| **WASD/スティック** | 移動入力（地上・壁中共通） | 共通 |

### 3.2 起動競合の回避（必須ゲート）

```
bBlockGASPTraversal = ClimbingComp.IsClimbingActive()

GASP Traversal 開始入口:
  IF bBlockGASPTraversal THEN
    RETURN (何もしない)
  END IF
```

> これにより「壁中に Parkour が割り込む」「同時に開始する」事故を根絶する。

---

## 4. 実施フェーズ（計画）

### Phase 0: GASP 導入・ベース確認

**目的**: AthleticTrial が素の状態で安定稼働していることを確認

**作業内容**:
- [ ] AthleticTrial プロジェクト起動
- [ ] サンプル通りに地上ロコ＋Parkour が動くことを確認
- [ ] Enhanced Input の処理位置を把握（IA_Jump/Traversal 要求の入口）

**Exit Criteria**:
- [ ] GASP が素の状態で安定稼働

---

### Phase 1: 入力設計・競合ゲート準備（v4.0 更新：既存入力アセット流用）

**目的**: 壁機能と GASP の競合を防ぐ基盤を構築

**作業内容**:

#### Step 1: 既存 Input Action の Migrate
```
1. AnimationTestProject から Migrate:
   - IA_GrabWall（→ E キーにリマップして使用）
   - IA_ClimbUp
   - IA_Release
   - IMC_Climbing

2. マイグレーション先:
   AthleticTrial/Content/Input/Climbing/
```

#### Step 2: IA_GrabWall をトグル対応に修正
```
[修正前]
IA_GrabWall → TryGrabWall() のみ

[修正後]
IA_GrabWall → ToggleAttach()
  → IsClimbingActive() ? ReleaseFromWall() : TryGrabWall()

※ IA_Release は ToggleAttach 方式により不要となる可能性あり
  （併存させて別キーに割当も可能）
```

#### Step 3: IMC_Climbing の設定調整
```
1. E キー → IA_GrabWall にマッピング追加
2. WASD キー → 既存の Move 入力を維持
3. Space キー → 壁中は無効化（GASP Traversal ブロック）
```

#### Step 4: 競合ゲート導入
```
1. `bBlockGASPTraversal = ClimbingComp.IsClimbingActive()` を導入
2. GASP Traversal 開始入口にブロック条件を追加:
   IF bBlockGASPTraversal THEN RETURN
```

**Exit Criteria**:
- [ ] 壁中は Parkour が発火しない
- [ ] 既存の IA_GrabWall, IMC_Climbing が正常に動作

---

### Phase 2: アニメーション資産のリターゲット ✅ 完了

**目的**: 1,250+ 個のアニメーションを GASP のスケルトンで使用可能にする

> **📘 詳細手順**: UE 5.5.4 対応の詳細な操作手順は `/Docs/Phase2_AnimationRetarget_DetailedGuide.md` を参照してください。
> Auto Retarget Chains 機能の活用方法、トラブルシューティング等を含みます。

**作業内容**:

#### Step 1: IK Rig 作成 ✅
```
1. 既存の IK_FreeAnimationLibrary を使用
   → パス: /Game/FreeAnimationLibrary/Animations/Rigs/IK_FreeAnimationLibrary
   → 正しいスケルトン（SK_Mannequin）で設定済み

2. チェーン設定（Auto Retarget Chains で自動設定済み）:
   - Spine: pelvis → spine_01 → ... → spine_05
   - LeftArm: clavicle_l → upperarm_l → lowerarm_l → hand_l
   - RightArm: clavicle_r → upperarm_r → lowerarm_r → hand_r
   - LeftLeg: thigh_l → calf_l → foot_l → ball_l
   - RightLeg: thigh_r → calf_r → foot_r → ball_r
   - Head: neck_01 → neck_02 → head

3. Retarget Root: pelvis に設定済み
```

#### Step 2: IK Retargeter 作成 ✅
```
1. IK Retargeter 作成済み
   → 名前: RTG_FreeAnim_to_UEFN
   → Source: IK_FreeAnimationLibrary
   → Target: IK_UEFN_Mannequin (既存)

2. Chain Mapping: Auto Map Chains で自動設定
```

#### Step 3: アニメーションコピー ✅
```
1. AnimationTestProject からコピー済み:
   - Content/FreeAnimationLibrary/ (133 アニメーション・21カテゴリ)
   - Content/FreeSampleAnimationSet/ (182 アニメーション・15カテゴリ)

2. コピー先:
   → AthleticTrial/Content/FreeAnimationLibrary/
   → AthleticTrial/Content/FreeSampleAnimationSet/
```

#### Step 4: バッチリターゲット ✅（UE 5.5.4 実証済み）

> **⚠️ UE 5.5.4 重要な差異**: メニュー名が「Retarget Animation Assets」ではなく「**Retarget Animations**」

```
1. リターゲット実行手順:
   - アニメーションを選択（Ctrl+A で全選択可）
   - 右クリック → 「Retarget Animations」 ← メニュー名に注意！

2. Retarget Animations ダイアログ設定:
   ┌─────────────────────────────────────────────────────────────┐
   │  Source Skeletal Mesh:                                      │
   │    SK_Mannequin                                             │
   │    (パス: /Game/FreeSampleAnimationSet/Demo/Mannequin_UE4/) │
   │                                                             │
   │  Target Skeletal Mesh:                                      │
   │    SKM_UEFN_Mannequin                                       │
   │    (パス: /Game/Characters/UEFN_Mannequin/Meshes/)          │
   │                                                             │
   │  ☐ Auto Generate Retargeter ← オフにする                   │
   │                                                             │
   │  Retarget Asset:                                            │
   │    RTG_FreeAnim_to_UEFN                                     │
   └─────────────────────────────────────────────────────────────┘

3. Export 設定:
   - ☑ Use Source Path: 元のフォルダ構造を維持
   - 出力先: /Game/Characters/UEFN_Mannequin/Animations/

4. 結果確認方法:
   - サムネイル色: オレンジ = リターゲット済み（UEFN_Mannequin）
   - ファイル名: 末尾に「1」が追加（例: A_JogBwd_Loop → A_JogBwd_Loop1）
   - スケルトン: SK_UEFN_Mannequin
```

#### 実証結果（2026-01-21）

| 項目 | 結果 |
|------|------|
| リターゲット数 | **1,250+ アニメーション** |
| 処理時間 | 数分程度 |
| エラー | なし |
| クラッシュ | なし |
| 出力先 | 元のフォルダ構造を維持 |

**Exit Criteria**:
- [x] 1,250+ アニメーションがリターゲット済み
- [x] Animation Preview で正常再生を確認

---

### Phase 3: AC_Climbing 改修（※ v3.0 で大幅変更）

**目的**: 既存の AC_Climbing（91%完成）を改修し、GASP 互換にする

> ~~BP_WallTraversalComponent 新規作成~~ → **AC_Climbing 流用**

**実施場所**: AnimationTestProject（単体テスト後に Migrate）

#### Step 1: 既存バグの修正（優先度: 高） ✅ 検証済み・対応不要

**問題**: 壁の近くでジャンプすると床を通り抜ける

**検証結果 (2026-01-22)**:
| 操作 | 結果 |
|------|------|
| 壁の近くでジャンプ | ✅ 床すり抜け **発生せず** |
| 壁掴みキー押下 | ✅ 床すり抜け **発生せず** |

**結論**: バグは再現しないため、修正不要

**検証時の実装状態** (`BP_ThirdPersonCharacter.StartClimbing()`):
```
1. Set bIsClimbing = true
2. Set Movement Mode = MOVE_Flying
3. Set Collision Enabled = QueryOnly
4. Set Collision Response = ECR_Overlap
5. Stop Movement Immediately
6. SwitchToClimbingInput()
```

> **注**: 過去のバグ分析ドキュメント（2025-01-05作成）に記載された問題は、
> 現在の実装では再現しない。原因は不明だが、その後の修正で解消された可能性がある。

~~**修正箇所**: `BP_ThirdPersonCharacter.StartClimbing()`~~

~~```~~
~~[修正前]~~
~~1. Set bIsClimbing = true~~
~~2. Set Movement Mode = MOVE_Flying~~
~~3. Set Collision Enabled = QueryOnly~~
~~4. SwitchToClimbingInput()~~

~~[修正後]~~
~~1. Set bIsClimbing = true~~
~~2. ClimbingComponent → Get WallHitLocation~~
~~3. Set Actor Location (WallHitLocation)  ← 追加~~
~~4. Set Movement Mode = MOVE_Flying~~
~~5. Set Collision Enabled = QueryOnly~~
~~6. SwitchToClimbingInput()~~
~~```~~

#### Step 2: IsClimbingActive 関数の追加（GASP競合ゲート用）

**AC_Climbing に追加**:

```
[Function] IsClimbingActive (Public, Pure)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
入力: なし
出力: Boolean

処理:
Return (bIsClimbing OR bIsOnLedge)
```

#### Step 3: ToggleAttach 関数の追加（Eキートグル対応）

**AC_Climbing に追加**:

```
[Function] ToggleAttach (Public)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
入力: なし
出力: なし

処理:
Branch (bIsClimbing OR bIsOnLedge)
├─ True: ReleaseFromWall()
└─ False: TryGrabWall()
```

#### Step 4: UpdateAnimationParameters 関数の実装

**AC_Climbing に追加**:

```
[Function] UpdateAnimationParameters
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
入力: なし
出力: なし

処理:
1. OwnerCharacter → Get Mesh → Get Anim Instance
2. Set Variable:
   - "ClimbHorizontal" = ClimbHorizontal
   - "ClimbVertical" = ClimbVertical
   - "bIsClimbing" = bIsClimbing
   - "bIsOnLedge" = bIsOnLedge
```

**呼び出し箇所**: Event Tick（bIsWallClimbingActive = true 時）

#### Step 5: TryGrabWall の修正（StartClimbing 呼び出し元の統一） ✅ 実装完了

**問題**: AC_Climbing 内に独自の `StartClimbing` 関数が存在し、`TryGrabWall` から呼ばれていた。
これにより、BP_ThirdPersonCharacter の `StartClimbing`（Collision 設定、Input 切り替え、デバッグ出力を含む完全な処理）が呼ばれていなかった。

**修正内容** (2026-01-22):

```
[修正前]
TryGrabWall
  → AttachToWall
  → StartClimbing (AC_Climbing 内の関数)  ← 不完全な処理
  → EnableWallClimbingTick

[修正後]
TryGrabWall
  → AttachToWall
  → Cast To BP_ThirdPersonCharacter (Object ← Get OwnerCharacter)
  → StartClimbing (BP_ThirdPersonCharacter の関数)  ← 完全な処理
  → EnableWallClimbingTick
```

**検証結果**:
| 項目 | 結果 |
|------|------|
| StartClimbing MovementMode = Flying 表示 | ✅ 正常に表示 |
| 壁吸着動作 | ✅ 正常に動作 |
| 壁移動（WASD） | ⚠️ 動作しない（別問題、後で修正） |

> **⚠️ GASP 統合時の注意**: 現在の実装では AC_Climbing が BP_ThirdPersonCharacter に依存している。
> GASP 統合（Phase 4）前に、**Step 6: イベントディスパッチャー実装**を完了すること。
> これにより、AC_Climbing をキャラクター非依存のコンポーネントとして Migrate 可能になる。

#### Step 6: イベントディスパッチャー実装（GASP 統合準備） ✅ 実装完了

**目的**: AC_Climbing を BP_ThirdPersonCharacter に依存しない汎用コンポーネントに変更

**採用方式**: アプローチ A: イベントディスパッチャー方式（2026-01-22 決定）

**工数見積もり**: 6.0-8.0h

##### 6.1 AC_Climbing にイベントディスパッチャーを追加

**追加するイベントディスパッチャー**:

| 名前 | 用途 | シグネチャ |
|------|------|-----------|
| `OnClimbingStarted` | 壁掴み開始時に発火 | 引数なし |
| `OnClimbingStopped` | 壁掴み終了時に発火 | 引数なし |
| `OnLedgeClimbingStarted` | レッジ掴み開始時（将来用） | 引数なし |
| `OnLedgeClimbingStopped` | レッジ掴み終了時（将来用） | 引数なし |

**手順**:
```
1. AC_Climbing を開く
2. My Blueprint パネル → Event Dispatchers セクションで「+」
3. OnClimbingStarted を作成
4. OnClimbingStopped を作成
5. （オプション）OnLedgeClimbingStarted, OnLedgeClimbingStopped を作成
```

##### 6.2 TryGrabWall の修正（イベント発火方式へ変更）

**現在の実装**（Step 5 完了後）:
```
TryGrabWall
  → AttachToWall
  → Cast To BP_ThirdPersonCharacter
  → StartClimbing (BP_ThirdPersonCharacter)  ← 直接呼び出し
  → EnableWallClimbingTick
```

**修正後**:
```
TryGrabWall
  → AttachToWall
  → Call OnClimbingStarted  ← イベント発火に変更
  → EnableWallClimbingTick
```

**手順**:
```
1. TryGrabWall 関数を開く
2. Cast To BP_ThirdPersonCharacter ノードを削除
3. StartClimbing 呼び出しを削除
4. AttachToWall の後に OnClimbingStarted (Call) ノードを追加
```

##### 6.3 ReleaseFromWall の修正

**修正内容**: StopClimbing 呼び出し前に OnClimbingStopped を発火

```
ReleaseFromWall
  → ... 既存処理 ...
  → Call OnClimbingStopped  ← 新規追加
```

##### 6.4 BP_ThirdPersonCharacter でイベントバインド

**作業場所**: BP_ThirdPersonCharacter → Event Graph → BeginPlay

**手順**:
```
1. BeginPlay イベントを探す
2. ClimbingComponent への参照を取得
3. Bind Event to OnClimbingStarted ノードを追加
   └─ Event → StartClimbing (Self) を呼ぶ
4. Bind Event to OnClimbingStopped ノードを追加
   └─ Event → StopClimbing (Self) を呼ぶ
```

**完成後のアーキテクチャ**:
```
AC_Climbing (汎用コンポーネント)
    │
    ├─ TryGrabWall()
    │      └─ Call OnClimbingStarted  ← イベント発火
    │
    └─ ReleaseFromWall()
           └─ Call OnClimbingStopped  ← イベント発火

           ↓ イベント伝播 ↓

BP_ThirdPersonCharacter (現プロジェクト)
    └─ BeginPlay で Bind
           ├─ OnClimbingStarted → StartClimbing()
           └─ OnClimbingStopped → StopClimbing()

CBP_SandboxCharacter (GASP - Phase 4)
    └─ BeginPlay で Bind
           ├─ OnClimbingStarted → GASP用処理
           └─ OnClimbingStopped → GASP用処理
```

##### Step 6 チェックリスト

- [x] OnClimbingStarted イベントディスパッチャーを追加 → **実装完了** (2026-01-22)
- [x] OnClimbingStopped イベントディスパッチャーを追加 → **実装完了** (2026-01-22)
- [x] TryGrabWall を修正（イベント発火方式） → **実装完了** (2026-01-22)
- [x] ReleaseFromWall を修正（イベント発火追加） → **実装完了** (2026-01-22)
- [x] BP_ThirdPersonCharacter で BeginPlay バインド実装 → **実装完了** (2026-01-22)
- [x] 動作テスト: 壁吸着 → StartClimbing が呼ばれることを確認 → **検証完了** (2026-01-22)
- [x] 動作テスト: 壁離脱 → StopClimbing が呼ばれることを確認 → **検証完了** (2026-01-22)

##### Step 6 Exit Criteria

- [x] AC_Climbing が BP_ThirdPersonCharacter を直接参照していない → **達成** (2026-01-22)
- [x] イベントディスパッチャー経由で StartClimbing/StopClimbing が正常動作 → **達成** (2026-01-22)
- [x] 「StartClimbing MovementMode = Flying」デバッグメッセージが表示される → **達成** (2026-01-22)

---

#### 既知の課題（Phase 3）

| 課題 | 優先度 | ステータス | 備考 |
|------|--------|-----------|------|
| ~~壁移動（WASD）が動作しない~~ | ~~中~~ | ✅ **解決済み** | Event Tick のガード条件修正で解決 (2026-01-23) |

**作業チェックリスト**:
- [x] ~~StartClimbing で即時位置固定を追加~~ → **検証済み・対応不要** (2026-01-22)
- [x] IsClimbingActive() 関数を追加 → **実装・検証完了** (2026-01-22)
- [x] ToggleAttach() 関数を追加 → **実装済み確認** (2026-01-23)
- [x] UpdateAnimationParameters() を実装 → **AnimBP 側で Pull 方式で実装済み確認** (2026-01-23)
- [x] 壁近くジャンプで床貫通しないことを確認 → **検証済み・問題なし** (2026-01-22)
- [x] E キーでトグル動作を確認 → **正常動作確認** (2026-01-23)
- [x] TryGrabWall を修正（BP_ThirdPersonCharacter::StartClimbing を呼ぶ） → **実装完了** (2026-01-22)
- [x] 壁移動（WASD）の問題を調査・修正 → **解決済み** (2026-01-23)
- [x] **Step 6: イベントディスパッチャー実装**（GASP 統合準備） → **実装・検証完了** (2026-01-22)
  - [x] OnClimbingStarted / OnClimbingStopped を AC_Climbing に追加
  - [x] TryGrabWall をイベント発火方式に変更
  - [x] ReleaseFromWall にイベント発火を追加
  - [x] BP_ThirdPersonCharacter で BeginPlay バインド実装

> **📋 Phase 3 完了サマリ（v4.16 更新）**
>
> ✅ **Phase 3 全作業完了！Phase 4 移行準備完了。**
>
> | # | 作業 | 状態 | 内容 |
> |---|------|------|------|
> | ~~1~~ | ~~ToggleAttach()~~ | ✅ **実装済み** | AC_Climbing に既存 (2026-01-23 確認) |
> | ~~2~~ | ~~UpdateAnimationParameters()~~ | ✅ **実装済み** | ABP_ThirdPerson_Extended で Pull 方式実装済み (2026-01-23 確認) |
> | ~~3~~ | ~~E キートグル動作確認~~ | ✅ **正常動作確認** | 最終テスト完了 (2026-01-23) |
>
> **📝 UpdateAnimationParameters 実装方式の補足:**
> - **計画書の設計**: AC_Climbing が AnimBP に Push（AC_Climbing → AnimBP）
> - **実際の実装**: AnimBP が AC_Climbing から Pull（AnimBP ← AC_Climbing）
> - **実装場所**: ABP_ThirdPerson_Extended の Event Blueprint Update Animation
> - **取得変数**: bIsClimbing, bIsOnLedge, ClimbHorizontal, ClimbVertical（全て AC_Climbing から取得）

**Exit Criteria**:
- [x] E 吸着 → 上下左右移動 → E 解除が安定動作 → **達成** (2026-01-23)
- [x] IsClimbingActive() が正しく状態を返す → **検証完了** (2026-01-22)
- [x] StartClimbing が正しく呼ばれる（デバッグメッセージ表示） → **検証完了** (2026-01-22)
- [x] **イベントディスパッチャー経由で StartClimbing/StopClimbing が正常動作** → **達成** (2026-01-22)

---

### Phase 4: AC_Climbing を GASP へ統合（v4.0 更新：全成果物一括 Migrate）

**目的**: 改修済み AC_Climbing および全関連成果物を AthleticTrial に統合

> **⚠️ 重要: Migrate 前の準備作業（v4.13 更新）**
>
> **Phase 3 の全残作業を完了してから Phase 4 を開始すること。**
>
> #### 採用方針: オプション A（Phase 3 完全完了 → Phase 4）
>
> | 方針 | 内容 | 採用状況 |
> |------|------|----------|
> | **オプション A** | Phase 3 残作業を AnimationTestProject で完了 → 一度で Migrate | ⭐ **採用** (2026-01-23) |
> | ~~オプション B~~ | ~~Phase 4 先行 → AthleticTrial で残作業を追加~~ | 不採用 |
>
> #### Phase 4 開始前の必須完了項目（v4.16 更新）✅ 全項目完了
>
> | # | 項目 | ステータス | 実施場所 |
> |---|------|-----------|----------|
> | 1 | Step 6: イベントディスパッチャー実装 | ✅ 完了 (2026-01-22) | AnimationTestProject |
> | 2 | ToggleAttach() 関数追加 | ✅ **実装済み確認** (2026-01-23) | AnimationTestProject |
> | 3 | UpdateAnimationParameters() 実装 | ✅ **実装済み確認** (2026-01-23) | ABP_ThirdPerson_Extended |
> | 4 | E キートグル動作確認 | ✅ **正常動作確認** (2026-01-23) | AnimationTestProject |
>
> #### オプション A 採用理由
> - AnimationTestProject で単体テストが容易
> - Migrate は一度で済む（手戻りなし）
> - AthleticTrial での追加修正が不要
> - 完成した AC_Climbing を確実に移行できる

**作業内容**:

#### Step 1: 全成果物一括 Migrate

```
1. Content Browser で以下を選択（全成果物）:

   [コア機能]
   - AC_Climbing
   - E_ClimbState
   - E_CornerType
   - BS_Climbing
   ※ BS_Ledge は未作成のため新規作成が必要

   [入力システム]（Phase 1 で未 Migrate の場合）
   - IA_GrabWall
   - IA_ClimbUp
   - IA_Release
   - IMC_Climbing

   [アニメーション]
   - AM_ClimbUp_At_Top（Animation Montage）
   - Climbing 系アニメーションシーケンス

2. 右クリック → Asset Actions → Migrate

3. マイグレーション先（カテゴリ別）:
   - コンポーネント: AthleticTrial/Content/Blueprints/Components/
   - Enum: AthleticTrial/Content/Blueprints/Enums/
   - BlendSpace: AthleticTrial/Content/Animation/BlendSpaces/
   - 入力: AthleticTrial/Content/Input/Climbing/
   - アニメーション: AthleticTrial/Content/Characters/UEFN_Mannequin/Animations/Imported/

4. 依存アセット確認:
   - アニメーション: ✓ 含める
   - スケルトン: ✓ 含める
   - マテリアル: ✗ 除外可
```

#### Migrate 成果物チェックリスト（v4.17 更新：全項目完了）

| 成果物 | 種別 | Migrate 先 | 確認 |
|--------|------|-----------|------|
| AC_Climbing | ActorComponent | `/ThirdPerson/Blueprints/Components/` | ✅ (2026-01-23) |
| E_ClimbState | Enum | `/ThirdPerson/Blueprints/Enums/` | ✅ (依存関係で自動) |
| E_CornerType | Enum | `/ThirdPerson/Blueprints/Enums/` | ✅ (依存関係で自動) |
| BS_Climbing | BlendSpace 2D | `/ThirdPerson/Blueprints/` | ✅ (2026-01-23) |
| BS_Ledge | BlendSpace 2D | **新規作成要** | ⏳ Phase 5 |
| IA_GrabWall | Input Action | `/ThirdPerson/Input/Actions/` | ✅ (依存関係で自動) |
| IA_ClimbUp | Input Action | `/ThirdPerson/Input/Actions/` | ✅ (依存関係で自動) |
| IA_Release | Input Action | `/ThirdPerson/Input/Actions/` | ✅ (依存関係で自動) |
| IMC_Climbing | Input Mapping Context | `/ThirdPerson/Input/` | ✅ (依存関係で自動) |
| ~~AM_ClimbUp_At_Top~~ | ~~Animation Montage~~ | ~~Animations/Imported/~~ | ✅ (既存確認済み) |

> **📝 Migrate 補足（v4.17）**
> - AC_Climbing を Migrate した際に、依存アセット（E_ClimbState, E_CornerType, IA_*, IMC_Climbing）が自動的に含まれた
> - AM_ClimbUp_At_Top は AthleticTrial に既に存在（リターゲット済み Climbing_Animations に含まれる）
> - BS_Ledge は Phase 5 で新規作成予定

#### Step 2: キャラクター BP への追加

```
1. CBP_SandboxCharacter を開く
2. AC_Climbing コンポーネントを追加
3. 入力接続:
   - IA_ClimbAttach (E) → ToggleAttach()
   - Move Input → SetClimbInput()
```

#### Step 3: 競合ゲート有効化

```
1. bBlockGASPTraversal 変数を追加（または既存変数を利用）
2. Event Tick で更新:
   ClimbingComp → IsClimbingActive() → Set bBlockGASPTraversal

3. GASP の Traversal 開始処理を特定
4. 以下を追加:
   IF bBlockGASPTraversal THEN
     RETURN
   END IF
```

#### Step 4: ABP への Climbing ステート追加

```
[Main State Machine]
├── Locomotion (既存)
├── Traversal (既存)
└── Climbing (新規)
    ├── Entry: bIsClimbing OR bIsOnLedge
    ├── ClimbingIdle
    ├── ClimbingMove (BS_Climbing)
    ├── LedgeIdle
    └── LedgeMove (BS_Ledge) ※新規作成要

[Transition]
Locomotion ↔ Climbing: bIsClimbing OR bIsOnLedge
```

#### Step 5: アニメーション参照の更新

```
AC_Climbing 内のアニメーション参照を更新:

[旧参照]                              → [新参照]
────────────────────────────────────────────────────
/ThirdPerson/Animations/Climbing_*    → /UEFN_Mannequin/Animations/Imported/Climbing_*_Retargeted
/ThirdPerson/Animations/LedgeClimb_*  → /UEFN_Mannequin/Animations/Imported/LedgeClimb_*_Retargeted
```

**Exit Criteria**:
- [ ] GASP 上で Space = Parkour、E = 壁吸着が共存
- [ ] 壁中に Space を押しても挙動が壊れない

---

### Phase 5: Motion Matching への統合

**目的**: リターゲットしたアニメーションを PoseSearch システムに組み込む

**作業内容**:

#### PoseSearchDatabase 作成
```
1. 新規 Database 作成:
   - PSD_Climbing_Dense (壁系アニメ)
   - PSD_Cover_Dense (カバー系)
   - PSD_AdditionalLocomotion_Dense (追加ロコモ)

2. Database 設定:
   - Schema: Schema_Dense (既存)
   - Normalization Set: NS_Locomotion (既存)

3. アニメーション追加 → Build
```

#### Chooser 設定
```
IF MovementState == Climbing THEN
    → PSD_Climbing_Dense
ELSE IF MovementState == Covering THEN
    → PSD_Cover_Dense
ELSE
    → Default Database
```

**Exit Criteria**:
- [ ] PoseSearchDatabase が正常にビルド
- [ ] Motion Matching でアニメーションが選択される
- [ ] パフォーマンスが許容範囲内

---

### Phase 6: 安定化・穴潰し

**目的**: エッジケースの対処と品質向上

**作業内容**:
- [ ] 端で止まる（左右端、天井/床）
- [ ] 壁距離維持（WallOffset）で浮き/めり込み抑制
- [ ] 解除時の復帰（Walking、速度、回転）を確実化
- [ ] デバッグ表示（壁検知 ON/OFF、法線、入力）を追加

**Exit Criteria**:
- [ ] テスト環境で再現性のあるバグが消える
- [ ] 全キャラクター（Manny, Quinn, Echo）で動作確認

---

## 5. リスクと対策

| リスク | 影響度 | 対策 |
|--------|--------|------|
| 競合（同時起動） | 高 | 入力分離（E/Space）＋ bBlockGASPTraversal ゲート |
| 壁からの浮き/めり込み | 中 | 毎 Tick 短トレース + WallOffset 固定 + Sweep=true |
| 左右移動の端・コーナーでスタック | 中 | 端は「止める」を初期仕様、コーナー追従は後回し |
| スケルトン互換性の問題 | 高 | 事前テストリターゲット実施 |
| Motion Matching 品質低下 | 高 | 既存 DB と分離、段階的追加 |
| パフォーマンス劣化 | 中 | LOD 設定、DB 分割 |
| AC_Climbing 参照エラー（Migrate後） | 中 | アニメーション参照を手動で更新 |

---

## 6. 動作確認チェックリスト（最終）

### GASP 基本機能
- [ ] GASP 地上ロコが通常通り動く
- [ ] Space で Parkour が動く

### 壁機能（基本）
- [ ] 壁前で E：吸着できる
- [ ] 吸着中：上下左右移動できる
- [ ] 壁の端で止まる（貫通しない）
- [ ] E で解除：Walking に復帰する

### 壁機能（高度）
- [ ] **壁頂上立ち**: 壁の頂上で IA_ClimbUp 入力 → 登り切りアニメ再生 → 壁の上に立つ
- [ ] **内壁コーナー移動**: 内側コーナー（凹角）で滑らかに次の壁へ遷移する
- [ ] ~~**外壁コーナー移動**: 外側コーナー（凸角）で滑らかに次の壁へ遷移する~~ **（現時点で除外）**
- [ ] レッジクライミングが動作する

### 競合回避
- [ ] 壁中に Space を押しても挙動が壊れない（無効化で OK）
- [ ] Parkour 中に E を押しても挙動が壊れない

### アニメーション
- [x] **1,250+ アニメーション**がリターゲット済み（Phase 2 完了）
- [ ] Motion Matching でアニメーションが選択される
- [ ] BS_Climbing が正常に動作する（BS_Ledge は新規作成後に確認）

### 全体
- [ ] 全キャラクター（Manny, Quinn, Echo）で動作確認
- [ ] パフォーマンスが許容範囲内

---

## 7. 推奨実行順序

```
1. Phase 0: GASP ベース確認
      ↓
2. Phase 2: アニメーションリターゲット（並行可能）
      ↓
3. Phase 3: AC_Climbing 改修（AnimationTestProject）
      ↓
4. Phase 1: 入力設計・競合ゲート準備
      ↓
5. Phase 4: AC_Climbing を GASP へ統合（Migrate）
      ↓
6. Phase 5: Motion Matching 統合
      ↓
7. Phase 6: 安定化
```

**理由**:
- Phase 2（リターゲット）は独立作業なので早期着手可能
- Phase 3（AC_Climbing 改修）は AnimationTestProject で単体テスト完了後に Migrate
- 既存の AC_Climbing を活用することで、新規実装の工数を大幅削減

---

## 8. 成果物一覧（v4.0 更新）

### 既存流用（Migrate のみ）

| # | 成果物 | フェーズ | 流用方法 |
|---|--------|---------|----------|
| 1 | **E_ClimbState** | Phase 4 | 直接 Migrate（変更なし） |
| 2 | **E_CornerType** | Phase 4 | 直接 Migrate（変更なし） |
| 3 | **BS_Climbing** | Phase 4 | 直接 Migrate（変更なし） |
| 4 | **BS_Ledge** | Phase 4 | **新規作成が必要**（未作成） |
| 5 | **IA_GrabWall** | Phase 1 | Migrate + E キーにリマップ |
| 6 | **IA_ClimbUp** | Phase 1 | 直接 Migrate（変更なし） |
| 7 | **IA_Release** | Phase 1 | Migrate（トグル方式で代替可） |
| 8 | **IMC_Climbing** | Phase 1 | Migrate + 設定調整 |
| 9 | **AM_ClimbUp_At_Top** | Phase 4 | 直接 Migrate（変更なし） |

### 既存改修

| # | 成果物 | フェーズ | 改修内容 |
|---|--------|---------|----------|
| 10 | **AC_Climbing** | Phase 3 | IsClimbingActive, ToggleAttach, UpdateAnimationParameters 追加 |

### 新規作成

| # | 成果物 | フェーズ | 備考 |
|---|--------|---------|------|
| 11 | IK_FreeAnimationLibrary | Phase 2 | IK Rig 新規作成 |
| 12 | RTG_FreeAnim_to_UEFN | Phase 2 | IK Retargeter 新規作成 |
| 13 | リターゲット済みアニメーション（140個） | Phase 2 | バッチ処理 |
| 14 | 競合ゲート（bBlockGASPTraversal） | Phase 1/4 | 変数＋ゲートロジック |
| 15 | ABP Climbing ステートマシン | Phase 4 | AnimBP に新規ステート追加 |
| 16 | PSD_Climbing_Dense 等 | Phase 5 | PoseSearchDatabase 新規作成 |
| 17 | 更新済み Chooser | Phase 5 | Chooser 修正 |

### 工数削減サマリ

| カテゴリ | v3.0 | v4.0 | 削減 |
|----------|------|------|------|
| 新規作成 | 9 項目 | 7 項目 | **-2 項目** |
| 既存流用 | 1 項目 | 9 項目 | **+8 項目** |
| 既存改修 | 1 項目 | 1 項目 | 同一 |

---

## 9. 変更履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|---------|
| 1.0 | 2026-01-20 | IntegrationPlan 初版作成 |
| 1.0 | 2026-01-20 | Third Person→GASP 計画書作成 |
| 2.0 | 2026-01-20 | 両計画書を統合、フェーズ構成を最適化 |
| 3.0 | 2026-01-20 | AC_Climbing 流用方針に更新、Phase 3 を大幅変更 |
| 4.0 | 2026-01-20 | 全成果物流用方針に更新 |
| | | - 既存 Input Actions (IA_GrabWall, IA_ClimbUp, IA_Release) の流用追加 |
| | | - IMC_Climbing の流用追加 |
| | | - BlendSpace (BS_Climbing) の流用明確化、BS_Ledge は未作成と判明 |
| | | - Enum (E_ClimbState, E_CornerType) の流用明確化 |
| | | - 成果物一覧を「既存流用/既存改修/新規作成」に分類 |
| | | - Phase 1, 4 を既存アセット流用方針で更新 |
| | | - 工数削減サマリを追加（新規作成 -2 項目、既存流用 +8 項目） |
| **4.1** | **2026-01-20** | **高度機能の追加記載：** |
| | | - **壁頂上立ち（Ledge Climb Up）** 機能を詳細記載（完成度70%） |
| | | - **内壁コーナー移動（Inner Corner Transition）** 機能を詳細記載（完成度60%） |
| | | - **外壁コーナー移動（Outer Corner Transition）** 機能を追記（完成度65%） |
| | | - 2.4, 2.5 節を新設（各機能の関数・変数・動作フロー詳細） |
| | | - 0.4 節に「高度機能」カテゴリを追加 |
| | | - 動作確認チェックリストを「基本」「高度」に分類 |
| **4.2** | **2026-01-20** | **外壁コーナー機能の一時除外：** |
| | | - **外壁コーナー移動** を現時点で除外（bEnableOuterCorner=false で無効化） |
| | | - 動作確認チェックリストから外壁コーナーを除外 |
| | | - 0.4 節の高度機能テーブルを更新（一時除外を明記） |
| **4.3** | **2026-01-21** | **検証結果を反映：** |
| | | - **BS_Ledge が未作成**であることを発見、計画書全体で修正（新規作成要に変更） |
| | | - **FreeAnimationLibrary**: 102個 → 133個（21カテゴリ）に修正 |
| | | - **FreeSampleAnimationSet**: 38個 → 182個（15カテゴリ）に修正 |
| | | - **AM_ClimbUp_At_Top** のパスを修正（FreeAnimationLibrary/Climbing_Animations/WallGrab_unGrab/内） |
| | | - **FreeAnimationLibrary と FreeSampleAnimationSet を AthleticTrial にコピー完了** |
| **4.4** | **2026-01-21** | **UE 5.5.4 対応：** |
| | | - ヘッダーに **対象環境: Unreal Engine 5.5.4** を明記 |
| | | - Phase 2 に **詳細ガイドへの参照**を追加（`/Docs/Phase2_AnimationRetarget_DetailedGuide.md`） |
| | | - 参照ドキュメントに **Phase 2 詳細ガイド**を追加 |
| | | - Phase 2 詳細ガイドを UE 5.5.4 対応版 (v2.0) に更新済み |
| **4.5** | **2026-01-21** | **Phase 2 完了・UE 5.5.4 実証結果を反映：** |
| | | - **Phase 2 全ステップ完了**（1,250+ アニメーションのリターゲット成功） |
| | | - **UE 5.5.4 バージョン差異を反映**: |
| | | - メニュー名: 「Retarget Animation Assets」→「**Retarget Animations**」 |
| | | - Retarget Animations ダイアログの設定手順を詳細追加 |
| | | - Use Source Path オプション（フォルダ構造維持）を追加 |
| | | - 命名規則: 末尾に「1」が追加されることを明記 |
| | | - サムネイル識別方法: オレンジ色 = リターゲット済み |
| | | - **実証結果テーブル追加**: 処理数・時間・エラー状況を記録 |
| | | - **動作確認チェックリスト更新**: アニメーション項目を完了マーク |
| | | - **ステータス更新**: Phase 2 セクションに ✅ 完了マーク追加 |
| **4.6** | **2026-01-22** | **Phase 3 Step 1 検証結果を反映：** |
| | | - **床すり抜けバグ検証**: 壁近くジャンプ・壁掴みキー押下両方で再現せず |
| | | - Phase 3 Step 1 を「✅ 検証済み・対応不要」に更新 |
| | | - 作業チェックリスト更新（床貫通確認・StartClimbing 修正を完了マーク） |
| | | - 検証方法: 実機テストで動作確認 |
| **4.7** | **2026-01-22** | **Phase 3 Step 2 関数名変更：** |
| | | - `IsActive` → `IsClimbingActive` に名称変更 |
| | | - 理由: ActorComponent 基底クラスの IsActive() と競合するため |
| | | - 計画書内の全参照箇所（9箇所）を一括更新 |
| **4.8** | **2026-01-22** | **Phase 3 Step 2 実装完了：** |
| | | - `IsClimbingActive()` 関数を AC_Climbing に追加 |
| | | - Pure 関数として実装（bIsClimbing OR bIsOnLedge を返す） |
| | | - 動作検証完了: 地上=false, 壁掴み中=true, レッジ中=true |
| | | - Exit Criteria「IsClimbingActive() が正しく状態を返す」達成 |
| **4.9** | **2026-01-22** | **Phase 3 Step 5 追加・TryGrabWall 修正：** |
| | | - **TryGrabWall 修正**: AC_Climbing::StartClimbing → BP_ThirdPersonCharacter::StartClimbing を呼ぶように変更 |
| | | - **理由**: デバッグ出力、Collision 設定、Input 切り替えを含む完全な処理を実行するため |
| | | - **検証結果**: 「StartClimbing MovementMode = Flying」が正常に表示、壁吸着動作 |
| | | - **既知の課題追加**: 壁移動（WASD）が動作しない問題を記録（後で修正） |
| | | - **Phase 4 に注意事項追加**: GASP 統合前にイベントディスパッチャー方式への移行を推奨 |
| | | - 作業チェックリストに TryGrabWall 修正を追加・完了マーク |
| | | - Exit Criteria に「StartClimbing が正しく呼ばれる」を追加・達成 |
| **4.10** | **2026-01-22** | **Phase 3 Step 6 追加：イベントディスパッチャー実装計画** |
| | | - **アーキテクチャ決定**: アプローチ A（イベントディスパッチャー方式）を採用 |
| | | - **Phase 3 に Step 6 を新設**: イベントディスパッチャー実装の詳細手順を追加 |
| | | - **追加するイベントディスパッチャー**: OnClimbingStarted, OnClimbingStopped |
| | | - **実装手順**: 6.1〜6.4 の4ステップで構成（AC_Climbing 変更 → BP バインド） |
| | | - **Step 6 チェックリスト・Exit Criteria を追加** |
| | | - **Phase 4 の注意事項を更新**: Step 6 への明確な参照、採用方式を明記 |
| | | - **作業チェックリストを更新**: イベントディスパッチャー関連タスクを追加 |
| **4.11** | **2026-01-22** | **Phase 3 Step 6 実装完了：イベントディスパッチャー** |
| | | - **AC_Climbing 修正完了**: |
| | | - OnClimbingStarted / OnClimbingStopped イベントディスパッチャーを追加 |
| | | - TryGrabWall: Cast + StartClimbing 直接呼び出し → Call OnClimbingStarted に変更 |
| | | - ReleaseFromWall: Cast + StopClimbing 削除、Call OnClimbingStopped を追加 |
| | | - **BP_ThirdPersonCharacter 修正完了**: |
| | | - BeginPlay で ClimbingComponent の OnClimbingStarted/OnClimbingStopped にバインド |
| | | - OnClimbingStartedHandler → StartClimbing(Self) |
| | | - OnClimbingStoppedHandler → StopClimbing(Self) |
| | | - **動作検証完了**: E キーで壁吸着/長押しで離脱、イベント経由で正常動作 |
| | | - **Step 6 チェックリスト・Exit Criteria 全項目達成** |
| | | - **GASP 統合準備完了**: AC_Climbing が BP_ThirdPersonCharacter を直接参照しなくなった |
| | | - **工数見積もり**: 6.0-8.0h（Phase 3 準備作業） |
| **4.12** | **2026-01-23** | **Phase 3 壁移動（WASD）問題解決：** |
| | | - **根本原因特定**: Event Tick の `Branch (bIsWallClimbingActive)` ガード条件が欠落 |
| | | - **修正内容**: Event Tick の先頭に `Branch (bIsWallClimbingActive)` を正しく接続 |
| | | - **正しいフロー**: |
| | | ```Event Tick → Branch (bIsWallClimbingActive) → [TRUE] → Branch (bIsClimbingUp) → [FALSE] → IsAtClimbTop → Set bIsAtClimbTop → UpdateClimbMovement → UpdateWallAttachment``` |
| | | - **問題の原因**: ガード条件がないと、クライミング中でない時も UpdateClimbMovement が実行され、ReleaseFromWall が誤って呼ばれる可能性があった |
| | | - **既知の課題「壁移動（WASD）が動作しない」を ✅ 解決済み に更新** |
| | | - **作業チェックリスト更新**: 壁移動（WASD）修正を完了マーク |
| | | - **Exit Criteria 達成**: E 吸着 → 上下左右移動 → E 解除が安定動作 |
| | | - 浮いているデバッグノード（Print String 等）を安全に削除、動作確認済み |
| **4.13** | **2026-01-23** | **Phase 3→4 移行方針決定：オプション A 採用** |
| | | - **採用方針**: Phase 3 残作業を AnimationTestProject で完了 → Phase 4 で一括 Migrate |
| | | - **不採用**: Phase 4 先行 → AthleticTrial で残作業追加（手戻りリスク） |
| | | - **Phase 4 前提条件を更新**: 残作業（ToggleAttach, UpdateAnimationParameters, Eキートグル確認）を必須化 |
| | | - **作業チェックリストを更新**: 残作業に「⚠️ Phase 4 前に完了要」マークを追加 |
| | | - **残作業サマリを追加**: Phase 3 完了に必要な作業を明確化 |
| | | - **オプション A 採用理由**: 単体テスト容易、Migrate 一度で済む、AthleticTrial での追加修正不要 |
| **4.14** | **2026-01-23** | **ToggleAttach() 実装済み確認** |
| | | - **発見**: ToggleAttach() は AC_Climbing に既に実装済み |
| | | - **実装内容**: `Branch (bIsClimbing OR bIsOnLedge) → True: ReleaseFromWall / False: TryGrabWall` |
| | | - **作業チェックリスト更新**: ToggleAttach() を完了マーク |
| | | - **残作業サマリ更新**: ToggleAttach() を実装済みに変更 |
| **4.15** | **2026-01-23** | **UpdateAnimationParameters() 実装済み確認・Phase 3 残作業完了** |
| | | - **発見**: UpdateAnimationParameters() は ABP_ThirdPerson_Extended で Pull 方式で実装済み |
| | | - **実装場所**: ABP_ThirdPerson_Extended の Event Blueprint Update Animation |
| | | - **実装方式**: AnimBP が AC_Climbing から Pull（計画書の Push 方式とは異なるが同等機能） |
| | | - **取得変数**: bIsClimbing, bIsOnLedge, ClimbHorizontal, ClimbVertical |
| | | - **Phase 3 実装作業完了**: ToggleAttach() + UpdateAnimationParameters() 共に実装済み確認 |
| | | - **残作業**: E キートグル動作確認（最終テスト）のみ |
| **4.16** | **2026-01-23** | **🎉 Phase 3 完了・Phase 4 移行準備完了** |
| | | - **E キートグル動作確認**: 正常動作確認完了 |
| | | - **Phase 3 全作業完了**: |
| | | - ✅ イベントディスパッチャー実装 |
| | | - ✅ ToggleAttach() 実装済み確認 |
| | | - ✅ UpdateAnimationParameters() 実装済み確認（Pull 方式） |
| | | - ✅ E キートグル動作確認 |
| | | - **Phase 4 移行準備完了**: AthleticTrial への Migrate 可能 |
| | | - **ステータス更新**: Phase 3 完了・Phase 4 移行準備完了 |
| **4.17** | **2026-01-23** | **🎉 Phase 4 Step 1 Migrate 完了** |
| | | - **Migrate 実行完了**: AnimationTestProject → AthleticTrial |
| | | - **Migrate 成果物（全8項目）**: |
| | | - ✅ AC_Climbing (`/ThirdPerson/Blueprints/Components/`) |
| | | - ✅ E_ClimbState (`/ThirdPerson/Blueprints/Enums/`) - 依存関係で自動 |
| | | - ✅ E_CornerType (`/ThirdPerson/Blueprints/Enums/`) - 依存関係で自動 |
| | | - ✅ BS_Climbing (`/ThirdPerson/Blueprints/`) |
| | | - ✅ IA_GrabWall (`/ThirdPerson/Input/Actions/`) - 依存関係で自動 |
| | | - ✅ IA_ClimbUp (`/ThirdPerson/Input/Actions/`) - 依存関係で自動 |
| | | - ✅ IA_Release (`/ThirdPerson/Input/Actions/`) - 依存関係で自動 |
| | | - ✅ IMC_Climbing (`/ThirdPerson/Input/`) - 依存関係で自動 |
| | | - **AM_ClimbUp_At_Top**: AthleticTrial に既存（Migrate 不要） |
| | | - **発見**: AC_Climbing Migrate 時に依存アセットが自動的に含まれる |
| | | - **次のステップ**: Phase 4 Step 2（GASP キャラクターへの AC_Climbing 統合） |

---

## 10. 参照ドキュメント

### 公式ドキュメント
- [Unreal Engine 5 Animation Retargeting](https://dev.epicgames.com/documentation/en-us/unreal-engine/animation-retargeting-in-unreal-engine)
- [Motion Matching in UE5](https://dev.epicgames.com/documentation/en-us/unreal-engine/pose-search-in-unreal-engine)
- [Game Animation Sample Documentation](https://dev.epicgames.com/documentation/en-us/unreal-engine/game-animation-sample-project-for-unreal-engine)
- [IK Rig Documentation](https://dev.epicgames.com/documentation/en-us/unreal-engine/ik-rig-in-unreal-engine)

### プロジェクト内ドキュメント
- `/Docs/Phase2_AnimationRetarget_DetailedGuide.md` - **Phase 2 リターゲット詳細手順（UE 5.5.4 対応）** ⭐
- `/Docs/ClimbingSystem_DetailedDesign.md` - AC_Climbing システム設計書
- `/Docs/ClimbingSystem_BugAnalysis_2025-01-05.md` - バグ分析レポート
- `/Docs/ClimbingSystem/Phase3_CharacterIntegration_TODO.md` - 統合TODOリスト

### 関連アセット（AnimationTestProject）- 流用対象

#### コア機能
- `/Game/ThirdPerson/Blueprints/Components/AC_Climbing` - メインコンポーネント（改修後 Migrate）
- `/Game/ThirdPerson/Blueprints/BP_ThirdPersonCharacter` - 参照用（統合パターン確認）

#### Enum
- `/Game/ThirdPerson/Blueprints/Enums/E_ClimbState` - 状態 Enum（直接 Migrate）
- `/Game/ThirdPerson/Blueprints/Enums/E_CornerType` - コーナー種別 Enum（直接 Migrate）

#### BlendSpace
- `/Game/ThirdPerson/Blueprints/BS_Climbing` - 壁クライミング用 BlendSpace 2D（直接 Migrate）
- ~~`/Game/ThirdPerson/Blueprints/BS_Ledge`~~ - **未作成**（新規作成が必要）

#### 入力システム
- `/Game/ThirdPerson/Input/Actions/IA_GrabWall` - 壁吸着 Input Action（E キーにリマップ）
- `/Game/ThirdPerson/Input/Actions/IA_ClimbUp` - 上昇 Input Action（直接 Migrate）
- `/Game/ThirdPerson/Input/Actions/IA_Release` - 解放 Input Action（直接 Migrate）
- `/Game/ThirdPerson/Input/IMC_Climbing` - クライミング用 Input Mapping Context（設定調整）
- `/Game/ThirdPerson/Input/IMC_Default` - デフォルト Input Mapping Context（参照用）

#### アニメーション
- `/Game/FreeAnimationLibrary/` - 133 アニメーション・21カテゴリ（**AthleticTrial にコピー済み**、リターゲット要）
- `/Game/FreeSampleAnimationSet/` - 182 アニメーション・15カテゴリ（**AthleticTrial にコピー済み**、リターゲット要）
- `/Game/FreeAnimationLibrary/Climbing_Animations/WallGrab_unGrab/AM_ClimbUp_At_Top` - レッジ登りモンタージュ（直接 Migrate）

---

**End of Document**
