# AnimationTestProject → AthleticTrial (GASP) 統合計画書 【統合版】

**作成日**: 2026-01-20
**バージョン**: 4.3 (検証結果を反映)
**ステータス**: 計画段階

---

## 0. 本計画書について

### 0.1 統合の経緯

本計画書は、以下の2つの計画書を比較・統合したものです：

1. **IntegrationPlan_AnimationTestProject_to_AthleticTrial.md**
   - 包括的なアニメーション資産移行（140アニメ）
   - AC_Climbing コンポーネント移行
   - Motion Matching 統合手順

2. **Third Person→GASP_統合計画書.md**
   - 壁機能に特化した BP_WallTraversalComponent 化
   - GASP Parkour との競合回避設計
   - `bBlockGASPTraversal` ゲート

### 0.2 統合方針（v4.0 更新）

| 観点 | 採用する設計 | 根拠 |
|------|-------------|------|
| **母艦** | AthleticTrial (GASP) | 両計画書で一致 |
| **壁機能** | **AC_Climbing 流用・改修** | 既存91%完成のAC_Climbingを活用（工数削減） |
| **競合回避** | **bBlockGASPTraversal ゲート** | シンプルで確実 |
| **入力システム** | **既存 Input Actions / IMC を流用** | IA_ClimbUp, IA_GrabWall, IA_Release, IMC_Climbing |
| **BlendSpace** | **既存 BS を流用** | BS_Climbing (8方向) ※BS_Ledge は未作成 |
| **Enum** | **既存 Enum を流用** | E_ClimbState, E_CornerType |
| **アニメ統合** | **詳細リターゲット手順** | 140アニメを確実に移行 |
| **Motion Matching** | **PoseSearchDB 作成手順** | 詳細な手順が有用 |
| **フェーズ分け** | **計画書2ベース** + 計画書1のアニメ手順 | 最小工数・段階的検証 |

### 0.3 v4.0 主要変更点

> **重要**: v4.0 では、プロジェクト内の **全既存成果物を最大限活用** し、新規作成を最小限に抑える方針に更新。

| 項目 | v3.0 (旧) | v4.0 (新) |
|------|-----------|-----------|
| 壁機能 | AC_Climbing 改修 | **AC_Climbing 改修**（継続） |
| 入力アクション | IA_ClimbAttach 新規作成 | **既存 IA_GrabWall を流用**（設定変更のみ） |
| Input Mapping | 新規作成前提 | **IMC_Climbing を流用**（Eキー追加のみ） |
| BlendSpace | 作成済み認識 | **BS_Climbing を直接 Migrate**、**BS_Ledge は新規作成要** |
| Enum | 作成済み認識 | **E_ClimbState, E_CornerType を直接 Migrate** |
| アニメーション | 140 個リターゲット | **140 個リターゲット**（継続） |
| ドキュメント | 参照のみ | **移行ガイドとして活用** |

### 0.4 流用可能な既存成果物一覧

#### コア機能（直接 Migrate）
| 成果物 | 種別 | 完成度 | 流用方法 |
|--------|------|--------|----------|
| **AC_Climbing** | ActorComponent | 91% | 改修後 Migrate |
| **E_ClimbState** | Enum | 100% | 直接 Migrate |
| **E_CornerType** | Enum | 100% | 直接 Migrate |
| **BS_Climbing** | BlendSpace 2D | 100% | 直接 Migrate |
| **BS_Ledge** | BlendSpace 2D | **未作成** | **新規作成が必要** |

#### 高度機能（AC_Climbing 内に実装済み）
| 機能 | 完成度 | 主要関数 | 流用方法 |
|------|--------|---------|----------|
| **壁頂上立ち（Ledge Climb Up）** | 70% | StartClimbUpTop, IsAtClimbTop, OnClimbUpFinished | AC_Climbing と一緒に Migrate |
| **内壁コーナー移動** | 60% | CheckInnerCorner, CheckCornerByDistance, SwitchToNextWall | AC_Climbing と一緒に Migrate |
| **外壁コーナー移動** | 65% | CheckOuterCornerByDistance, DetectNextWall | **現時点で除外**（bEnableOuterCorner=false で無効化） |

#### 入力システム（流用・再構成）
| 成果物 | 種別 | 用途 | 流用方法 |
|--------|------|------|----------|
| **IA_GrabWall** | Input Action | 壁吸着トリガー | **E キーにリマップして流用** |
| **IA_ClimbUp** | Input Action | 上方向移動 | W キーと併用可能 |
| **IA_Release** | Input Action | 壁からの解放 | E トグル対応に変更 |
| **IMC_Climbing** | Input Mapping Context | クライミング中の入力 | 設定調整で流用 |
| **IMC_Default** | Input Mapping Context | 地上移動の入力 | そのまま流用 |

#### アニメーション資産（リターゲット後に利用）
| 成果物 | 数量 | 内容 |
|--------|------|------|
| **FreeAnimationLibrary** | 133 個 | ロコモーション、アクション系（21カテゴリ） |
| **FreeSampleAnimationSet** | 182 個 | サンプルアニメーション（15カテゴリ） |
| **AM_ClimbUp_At_Top** | 1 個 | レッジ登り上げモンタージュ（FreeAnimationLibrary/Climbing_Animations/WallGrab_unGrab/内） |

#### ドキュメント（参照・ガイドとして活用）
| ドキュメント | 内容 | 活用方法 |
|--------------|------|----------|
| `ClimbingSystem_DetailedDesign.md` | AC_Climbing 設計書 | 改修時の参照 |
| `ClimbingSystem_BugAnalysis_*.md` | バグ分析レポート | 既知問題の把握 |
| `Phase3_CharacterIntegration_TODO.md` | 統合 TODO | 作業チェックリスト |
| `検討・議事録/WallClimbing_*.md` | 議事録・検討記録 | 設計判断の経緯確認 |

---

## 1. 目的

* AnimationTestProject で開発済みの **壁吸着＋壁移動（上下左右）** を GASP と共存させる
* **FreeAnimationLibrary (133個)** と **FreeSampleAnimationSet (182個)** を GASP の Motion Matching に統合
* 競合（同時起動・アニメ/移動の食い違い）を避けつつ、統合作業を資産化

---

## 2. 統合方針（最重要）

### 2.1 採用アーキテクチャ

* **GASP (AthleticTrial) を母艦**にする（GASP側の成立条件を崩さない）
* 壁機能は **既存の AC_Climbing を改修**し、GASPキャラへ搭載

### 2.2 機能分担

| 機能 | 担当システム | 変更 |
|------|-------------|------|
| 地上ロコモーション | GASP Motion Matching | 変更しない |
| Parkour（vault/ledge等） | GASP Traversal | 使用する |
| 壁機能（吸着・上下左右移動） | **AC_Climbing（改修）** | 改修後に Migrate |
| 壁ジャンプ | — | 実装しない |
| 追加アニメーション（140個） | Motion Matching 統合 | リターゲット後に追加 |

### 2.3 AC_Climbing 既存実装の活用

AC_Climbing は既に **91%完成** しており、以下の機能が実装済み：

| 機能 | 状態 | 完成度 | 備考 |
|------|------|--------|------|
| 壁検知（LineTrace） | ✅ 実装済み | 100% | CheckForClimbableSurface |
| 壁吸着・補間処理 | ✅ 実装済み | 100% | AttachToWall, UpdateWallAttachment |
| 8方向移動 | ✅ 実装済み | 100% | UpdateClimbMovement |
| **壁頂上立ち（Ledge Climb Up）** | ✅ 実装済み | **70%** | StartClimbUpTop, IsAtClimbTop, AM_ClimbUp_At_Top |
| **内壁コーナー移動** | ✅ 実装済み | **60%** | CheckInnerCorner, CheckCornerByDistance, SwitchToNextWall |
| 外壁コーナー移動 | ⏸️ 一時除外 | 65% | CheckOuterCornerByDistance, DetectNextWall（bEnableOuterCorner=false で無効化） |
| レッジクライミング | ✅ 実装済み | 70% | Ledge系関数群 |
| Input統合 | ✅ 実装済み | 100% | IMC_Climbing, IMC_Default 切替 |
| BlendSpace | ✅ 作成済み | **50%** | BS_Climbing のみ (**BS_Ledge は未作成**) |
| Animation連携 | ⚠️ 未実装 | 0% | UpdateAnimationParameters 要実装 |
| GASP競合ゲート | ❌ 未実装 | 0% | IsActive(), bBlockGASPTraversal 要追加 |

### 2.4 壁頂上立ち（Ledge Climb Up）詳細

**概要**: 壁の頂上（レッジ）に到達した際に、壁の上に立ち上がる機能

#### 実装済み関数・変数

| 項目 | 名称 | 説明 |
|------|------|------|
| 関数 | **StartClimbUpTop()** | 壁頂上登り切り開始 |
| 関数 | **IsAtClimbTop()** | 頂上到達判定（Head位置からLineTrace） |
| 関数 | **OnClimbUpFinished()** | 登り切りアニメ終了後処理 |
| 変数 | bIsClimbingUp | 登り切り中フラグ |
| 変数 | bIsAtClimbTop | 頂上到達フラグ |
| 変数 | ClimbUpTargetLocation | 登り切り目標位置 |
| 変数 | ClimbUpMontage | 登り切りアニメーション参照 |

#### 動作フロー

```
IsAtClimbTop() で頂上検知（壁が途切れた）
  ↓
IA_ClimbUp 入力を待機
  ↓
StartClimbUpTop() → AM_ClimbUp_At_Top 再生
  ↓
OnClimbUpFinished() → 目標位置へ移動 → StopClimbing()
```

#### 使用アセット

| アセット | 種別 | ステータス |
|---------|------|----------|
| **AM_ClimbUp_At_Top** | Animation Montage | ✅ 作成済み・流用可能 |

### 2.5 内壁コーナー移動（Inner Corner Transition）詳細

**概要**: 壁の内側コーナー（凹角、90度以上の角）での移動・遷移機能

#### 実装済み関数・変数

| 項目 | 名称 | 説明 |
|------|------|------|
| 関数 | **CheckInnerCorner()** | 内壁コーナー検知 |
| 関数 | **CheckCornerByDistance()** | 距離ベース内コーナー判定 |
| 関数 | **SwitchToNextWall()** | 次の壁への遷移実行 |
| 変数 | bIsCornerDetected | コーナー検知フラグ |
| 変数 | CornerType | E_CornerType（None/Outer/Inner） |
| 変数 | NextWallNormal | 次の壁の法線ベクトル |
| 変数 | NextWallHitLocation | 次の壁での吸着位置 |
| 変数 | CornerDetectionDistance | 内コーナー検知距離 |
| 変数 | CornerTransitionThreshold | 遷移判定閾値 |

#### 動作フロー

```
UpdateClimbMovement() 中
  ↓
移動方向へ Line Trace
  ↓
HIT時: CheckCornerByDistance(MoveDirection)
  ↓
法線変化量をチェック（Dot Product < 0.7 = 内壁コーナー）
  ↓
SwitchToNextWall() → 次の壁へ滑らかに遷移
```

#### 使用アセット

| アセット | 種別 | ステータス |
|---------|------|----------|
| **E_CornerType** | Enum | ✅ 作成済み・流用可能 |

---

## 3. 競合回避ポリシー

### 3.1 入力割当

| キー | 機能 | 優先度 |
|------|------|--------|
| **Space** | GASP Parkour / Jump | 標準 |
| **E** | 壁吸着トグル（Attach/Exit） | 壁前提時のみ |
| **WASD/スティック** | 移動入力（地上・壁中共通） | 共通 |

### 3.2 起動競合の回避（必須ゲート）

```
bBlockGASPTraversal = ClimbingComp.IsActive()

GASP Traversal 開始入口:
  IF bBlockGASPTraversal THEN
    RETURN (何もしない)
  END IF
```

> これにより「壁中に Parkour が割り込む」「同時に開始する」事故を根絶する。

---

## 4. 実施フェーズ（計画）

### Phase 0: GASP 導入・ベース確認

**目的**: AthleticTrial が素の状態で安定稼働していることを確認

**作業内容**:
- [ ] AthleticTrial プロジェクト起動
- [ ] サンプル通りに地上ロコ＋Parkour が動くことを確認
- [ ] Enhanced Input の処理位置を把握（IA_Jump/Traversal 要求の入口）

**Exit Criteria**:
- [ ] GASP が素の状態で安定稼働

---

### Phase 1: 入力設計・競合ゲート準備（v4.0 更新：既存入力アセット流用）

**目的**: 壁機能と GASP の競合を防ぐ基盤を構築

**作業内容**:

#### Step 1: 既存 Input Action の Migrate
```
1. AnimationTestProject から Migrate:
   - IA_GrabWall（→ E キーにリマップして使用）
   - IA_ClimbUp
   - IA_Release
   - IMC_Climbing

2. マイグレーション先:
   AthleticTrial/Content/Input/Climbing/
```

#### Step 2: IA_GrabWall をトグル対応に修正
```
[修正前]
IA_GrabWall → TryGrabWall() のみ

[修正後]
IA_GrabWall → ToggleAttach()
  → IsActive() ? ReleaseFromWall() : TryGrabWall()

※ IA_Release は ToggleAttach 方式により不要となる可能性あり
  （併存させて別キーに割当も可能）
```

#### Step 3: IMC_Climbing の設定調整
```
1. E キー → IA_GrabWall にマッピング追加
2. WASD キー → 既存の Move 入力を維持
3. Space キー → 壁中は無効化（GASP Traversal ブロック）
```

#### Step 4: 競合ゲート導入
```
1. `bBlockGASPTraversal = ClimbingComp.IsActive()` を導入
2. GASP Traversal 開始入口にブロック条件を追加:
   IF bBlockGASPTraversal THEN RETURN
```

**Exit Criteria**:
- [ ] 壁中は Parkour が発火しない
- [ ] 既存の IA_GrabWall, IMC_Climbing が正常に動作

---

### Phase 2: アニメーション資産のリターゲット

**目的**: 140個のアニメーションを GASP のスケルトンで使用可能にする

**作業内容**:

#### Step 1: IK Rig 作成
```
1. AthleticTrial で IK Rig を作成
   → 名前: IK_FreeAnimationLibrary

2. チェーン設定:
   - Spine: pelvis → spine_01 → ... → spine_05
   - LeftArm: clavicle_l → upperarm_l → lowerarm_l → hand_l
   - RightArm: clavicle_r → upperarm_r → lowerarm_r → hand_r
   - LeftLeg: thigh_l → calf_l → foot_l → ball_l
   - RightLeg: thigh_r → calf_r → foot_r → ball_r
   - Head: neck_01 → neck_02 → head

3. Retarget Root を pelvis に設定
```

#### Step 2: IK Retargeter 作成
```
1. IK Retargeter 作成
   → 名前: RTG_FreeAnim_to_UEFN
   → Source: IK_FreeAnimationLibrary
   → Target: IK_UEFN_Mannequin (既存)

2. Chain Mapping 確認・調整
```

#### Step 3: アニメーションの Migrate
```
1. AnimationTestProject から Migrate:
   - Content/FreeAnimationLibrary/Animations/
   - Content/FreeSampleAnimationSet/

2. マイグレーション先:
   → AthleticTrial/Content/Characters/UEFN_Mannequin/Animations/Imported/
```

#### Step 4: バッチリターゲット
```
1. リターゲット設定:
   - IK Retargeter: RTG_FreeAnim_to_UEFN
   - Target Skeleton: SK_UEFN_Mannequin

2. 出力先:
   /Game/Characters/UEFN_Mannequin/Animations/Imported/
```

**Exit Criteria**:
- [ ] 140 アニメーションがリターゲット済み
- [ ] Animation Preview で正常再生を確認

---

### Phase 3: AC_Climbing 改修（※ v3.0 で大幅変更）

**目的**: 既存の AC_Climbing（91%完成）を改修し、GASP 互換にする

> ~~BP_WallTraversalComponent 新規作成~~ → **AC_Climbing 流用**

**実施場所**: AnimationTestProject（単体テスト後に Migrate）

#### Step 1: 既存バグの修正（優先度: 高）

**問題**: 壁の近くでジャンプすると床を通り抜ける

**修正箇所**: `BP_ThirdPersonCharacter.StartClimbing()`

```
[修正前]
1. Set bIsClimbing = true
2. Set Movement Mode = MOVE_Flying
3. Set Collision Enabled = QueryOnly
4. SwitchToClimbingInput()

[修正後]
1. Set bIsClimbing = true
2. ClimbingComponent → Get WallHitLocation
3. Set Actor Location (WallHitLocation)  ← 追加
4. Set Movement Mode = MOVE_Flying
5. Set Collision Enabled = QueryOnly
6. SwitchToClimbingInput()
```

#### Step 2: IsActive 関数の追加（GASP競合ゲート用）

**AC_Climbing に追加**:

```
[Function] IsActive (Public, Pure)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
入力: なし
出力: Boolean

処理:
Return (bIsClimbing OR bIsOnLedge)
```

#### Step 3: ToggleAttach 関数の追加（Eキートグル対応）

**AC_Climbing に追加**:

```
[Function] ToggleAttach (Public)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
入力: なし
出力: なし

処理:
Branch (bIsClimbing OR bIsOnLedge)
├─ True: ReleaseFromWall()
└─ False: TryGrabWall()
```

#### Step 4: UpdateAnimationParameters 関数の実装

**AC_Climbing に追加**:

```
[Function] UpdateAnimationParameters
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
入力: なし
出力: なし

処理:
1. OwnerCharacter → Get Mesh → Get Anim Instance
2. Set Variable:
   - "ClimbHorizontal" = ClimbHorizontal
   - "ClimbVertical" = ClimbVertical
   - "bIsClimbing" = bIsClimbing
   - "bIsOnLedge" = bIsOnLedge
```

**呼び出し箇所**: Event Tick（bIsWallClimbingActive = true 時）

**作業チェックリスト**:
- [ ] StartClimbing で即時位置固定を追加
- [ ] IsActive() 関数を追加
- [ ] ToggleAttach() 関数を追加
- [ ] UpdateAnimationParameters() を実装
- [ ] 壁近くジャンプで床貫通しないことを確認
- [ ] E キーでトグル動作を確認

**Exit Criteria**:
- [ ] E 吸着 → 上下左右移動 → E 解除が安定動作
- [ ] IsActive() が正しく状態を返す

---

### Phase 4: AC_Climbing を GASP へ統合（v4.0 更新：全成果物一括 Migrate）

**目的**: 改修済み AC_Climbing および全関連成果物を AthleticTrial に統合

**作業内容**:

#### Step 1: 全成果物一括 Migrate

```
1. Content Browser で以下を選択（全成果物）:

   [コア機能]
   - AC_Climbing
   - E_ClimbState
   - E_CornerType
   - BS_Climbing
   ※ BS_Ledge は未作成のため新規作成が必要

   [入力システム]（Phase 1 で未 Migrate の場合）
   - IA_GrabWall
   - IA_ClimbUp
   - IA_Release
   - IMC_Climbing

   [アニメーション]
   - AM_ClimbUp_At_Top（Animation Montage）
   - Climbing 系アニメーションシーケンス

2. 右クリック → Asset Actions → Migrate

3. マイグレーション先（カテゴリ別）:
   - コンポーネント: AthleticTrial/Content/Blueprints/Components/
   - Enum: AthleticTrial/Content/Blueprints/Enums/
   - BlendSpace: AthleticTrial/Content/Animation/BlendSpaces/
   - 入力: AthleticTrial/Content/Input/Climbing/
   - アニメーション: AthleticTrial/Content/Characters/UEFN_Mannequin/Animations/Imported/

4. 依存アセット確認:
   - アニメーション: ✓ 含める
   - スケルトン: ✓ 含める
   - マテリアル: ✗ 除外可
```

#### Migrate 成果物チェックリスト

| 成果物 | 種別 | Migrate 先 | 確認 |
|--------|------|-----------|------|
| AC_Climbing | ActorComponent | Blueprints/Components/ | [ ] |
| E_ClimbState | Enum | Blueprints/Enums/ | [ ] |
| E_CornerType | Enum | Blueprints/Enums/ | [ ] |
| BS_Climbing | BlendSpace 2D | Animation/BlendSpaces/ | [ ] |
| BS_Ledge | BlendSpace 2D | **新規作成要** | [ ] |
| IA_GrabWall | Input Action | Input/Climbing/ | [ ] |
| IA_ClimbUp | Input Action | Input/Climbing/ | [ ] |
| IA_Release | Input Action | Input/Climbing/ | [ ] |
| IMC_Climbing | Input Mapping Context | Input/Climbing/ | [ ] |
| AM_ClimbUp_At_Top | Animation Montage | Animations/Imported/ | [ ] |

#### Step 2: キャラクター BP への追加

```
1. CBP_SandboxCharacter を開く
2. AC_Climbing コンポーネントを追加
3. 入力接続:
   - IA_ClimbAttach (E) → ToggleAttach()
   - Move Input → SetClimbInput()
```

#### Step 3: 競合ゲート有効化

```
1. bBlockGASPTraversal 変数を追加（または既存変数を利用）
2. Event Tick で更新:
   ClimbingComp → IsActive() → Set bBlockGASPTraversal

3. GASP の Traversal 開始処理を特定
4. 以下を追加:
   IF bBlockGASPTraversal THEN
     RETURN
   END IF
```

#### Step 4: ABP への Climbing ステート追加

```
[Main State Machine]
├── Locomotion (既存)
├── Traversal (既存)
└── Climbing (新規)
    ├── Entry: bIsClimbing OR bIsOnLedge
    ├── ClimbingIdle
    ├── ClimbingMove (BS_Climbing)
    ├── LedgeIdle
    └── LedgeMove (BS_Ledge) ※新規作成要

[Transition]
Locomotion ↔ Climbing: bIsClimbing OR bIsOnLedge
```

#### Step 5: アニメーション参照の更新

```
AC_Climbing 内のアニメーション参照を更新:

[旧参照]                              → [新参照]
────────────────────────────────────────────────────
/ThirdPerson/Animations/Climbing_*    → /UEFN_Mannequin/Animations/Imported/Climbing_*_Retargeted
/ThirdPerson/Animations/LedgeClimb_*  → /UEFN_Mannequin/Animations/Imported/LedgeClimb_*_Retargeted
```

**Exit Criteria**:
- [ ] GASP 上で Space = Parkour、E = 壁吸着が共存
- [ ] 壁中に Space を押しても挙動が壊れない

---

### Phase 5: Motion Matching への統合

**目的**: リターゲットしたアニメーションを PoseSearch システムに組み込む

**作業内容**:

#### PoseSearchDatabase 作成
```
1. 新規 Database 作成:
   - PSD_Climbing_Dense (壁系アニメ)
   - PSD_Cover_Dense (カバー系)
   - PSD_AdditionalLocomotion_Dense (追加ロコモ)

2. Database 設定:
   - Schema: Schema_Dense (既存)
   - Normalization Set: NS_Locomotion (既存)

3. アニメーション追加 → Build
```

#### Chooser 設定
```
IF MovementState == Climbing THEN
    → PSD_Climbing_Dense
ELSE IF MovementState == Covering THEN
    → PSD_Cover_Dense
ELSE
    → Default Database
```

**Exit Criteria**:
- [ ] PoseSearchDatabase が正常にビルド
- [ ] Motion Matching でアニメーションが選択される
- [ ] パフォーマンスが許容範囲内

---

### Phase 6: 安定化・穴潰し

**目的**: エッジケースの対処と品質向上

**作業内容**:
- [ ] 端で止まる（左右端、天井/床）
- [ ] 壁距離維持（WallOffset）で浮き/めり込み抑制
- [ ] 解除時の復帰（Walking、速度、回転）を確実化
- [ ] デバッグ表示（壁検知 ON/OFF、法線、入力）を追加

**Exit Criteria**:
- [ ] テスト環境で再現性のあるバグが消える
- [ ] 全キャラクター（Manny, Quinn, Echo）で動作確認

---

## 5. リスクと対策

| リスク | 影響度 | 対策 |
|--------|--------|------|
| 競合（同時起動） | 高 | 入力分離（E/Space）＋ bBlockGASPTraversal ゲート |
| 壁からの浮き/めり込み | 中 | 毎 Tick 短トレース + WallOffset 固定 + Sweep=true |
| 左右移動の端・コーナーでスタック | 中 | 端は「止める」を初期仕様、コーナー追従は後回し |
| スケルトン互換性の問題 | 高 | 事前テストリターゲット実施 |
| Motion Matching 品質低下 | 高 | 既存 DB と分離、段階的追加 |
| パフォーマンス劣化 | 中 | LOD 設定、DB 分割 |
| AC_Climbing 参照エラー（Migrate後） | 中 | アニメーション参照を手動で更新 |

---

## 6. 動作確認チェックリスト（最終）

### GASP 基本機能
- [ ] GASP 地上ロコが通常通り動く
- [ ] Space で Parkour が動く

### 壁機能（基本）
- [ ] 壁前で E：吸着できる
- [ ] 吸着中：上下左右移動できる
- [ ] 壁の端で止まる（貫通しない）
- [ ] E で解除：Walking に復帰する

### 壁機能（高度）
- [ ] **壁頂上立ち**: 壁の頂上で IA_ClimbUp 入力 → 登り切りアニメ再生 → 壁の上に立つ
- [ ] **内壁コーナー移動**: 内側コーナー（凹角）で滑らかに次の壁へ遷移する
- [ ] ~~**外壁コーナー移動**: 外側コーナー（凸角）で滑らかに次の壁へ遷移する~~ **（現時点で除外）**
- [ ] レッジクライミングが動作する

### 競合回避
- [ ] 壁中に Space を押しても挙動が壊れない（無効化で OK）
- [ ] Parkour 中に E を押しても挙動が壊れない

### アニメーション
- [ ] 140 アニメーションがリターゲット済み
- [ ] Motion Matching でアニメーションが選択される
- [ ] BS_Climbing が正常に動作する（BS_Ledge は新規作成後に確認）

### 全体
- [ ] 全キャラクター（Manny, Quinn, Echo）で動作確認
- [ ] パフォーマンスが許容範囲内

---

## 7. 推奨実行順序

```
1. Phase 0: GASP ベース確認
      ↓
2. Phase 2: アニメーションリターゲット（並行可能）
      ↓
3. Phase 3: AC_Climbing 改修（AnimationTestProject）
      ↓
4. Phase 1: 入力設計・競合ゲート準備
      ↓
5. Phase 4: AC_Climbing を GASP へ統合（Migrate）
      ↓
6. Phase 5: Motion Matching 統合
      ↓
7. Phase 6: 安定化
```

**理由**:
- Phase 2（リターゲット）は独立作業なので早期着手可能
- Phase 3（AC_Climbing 改修）は AnimationTestProject で単体テスト完了後に Migrate
- 既存の AC_Climbing を活用することで、新規実装の工数を大幅削減

---

## 8. 成果物一覧（v4.0 更新）

### 既存流用（Migrate のみ）

| # | 成果物 | フェーズ | 流用方法 |
|---|--------|---------|----------|
| 1 | **E_ClimbState** | Phase 4 | 直接 Migrate（変更なし） |
| 2 | **E_CornerType** | Phase 4 | 直接 Migrate（変更なし） |
| 3 | **BS_Climbing** | Phase 4 | 直接 Migrate（変更なし） |
| 4 | **BS_Ledge** | Phase 4 | **新規作成が必要**（未作成） |
| 5 | **IA_GrabWall** | Phase 1 | Migrate + E キーにリマップ |
| 6 | **IA_ClimbUp** | Phase 1 | 直接 Migrate（変更なし） |
| 7 | **IA_Release** | Phase 1 | Migrate（トグル方式で代替可） |
| 8 | **IMC_Climbing** | Phase 1 | Migrate + 設定調整 |
| 9 | **AM_ClimbUp_At_Top** | Phase 4 | 直接 Migrate（変更なし） |

### 既存改修

| # | 成果物 | フェーズ | 改修内容 |
|---|--------|---------|----------|
| 10 | **AC_Climbing** | Phase 3 | IsActive, ToggleAttach, UpdateAnimationParameters 追加 |

### 新規作成

| # | 成果物 | フェーズ | 備考 |
|---|--------|---------|------|
| 11 | IK_FreeAnimationLibrary | Phase 2 | IK Rig 新規作成 |
| 12 | RTG_FreeAnim_to_UEFN | Phase 2 | IK Retargeter 新規作成 |
| 13 | リターゲット済みアニメーション（140個） | Phase 2 | バッチ処理 |
| 14 | 競合ゲート（bBlockGASPTraversal） | Phase 1/4 | 変数＋ゲートロジック |
| 15 | ABP Climbing ステートマシン | Phase 4 | AnimBP に新規ステート追加 |
| 16 | PSD_Climbing_Dense 等 | Phase 5 | PoseSearchDatabase 新規作成 |
| 17 | 更新済み Chooser | Phase 5 | Chooser 修正 |

### 工数削減サマリ

| カテゴリ | v3.0 | v4.0 | 削減 |
|----------|------|------|------|
| 新規作成 | 9 項目 | 7 項目 | **-2 項目** |
| 既存流用 | 1 項目 | 9 項目 | **+8 項目** |
| 既存改修 | 1 項目 | 1 項目 | 同一 |

---

## 9. 変更履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|---------|
| 1.0 | 2026-01-20 | IntegrationPlan 初版作成 |
| 1.0 | 2026-01-20 | Third Person→GASP 計画書作成 |
| 2.0 | 2026-01-20 | 両計画書を統合、フェーズ構成を最適化 |
| 3.0 | 2026-01-20 | AC_Climbing 流用方針に更新、Phase 3 を大幅変更 |
| 4.0 | 2026-01-20 | 全成果物流用方針に更新 |
| | | - 既存 Input Actions (IA_GrabWall, IA_ClimbUp, IA_Release) の流用追加 |
| | | - IMC_Climbing の流用追加 |
| | | - BlendSpace (BS_Climbing) の流用明確化、BS_Ledge は未作成と判明 |
| | | - Enum (E_ClimbState, E_CornerType) の流用明確化 |
| | | - 成果物一覧を「既存流用/既存改修/新規作成」に分類 |
| | | - Phase 1, 4 を既存アセット流用方針で更新 |
| | | - 工数削減サマリを追加（新規作成 -2 項目、既存流用 +8 項目） |
| **4.1** | **2026-01-20** | **高度機能の追加記載：** |
| | | - **壁頂上立ち（Ledge Climb Up）** 機能を詳細記載（完成度70%） |
| | | - **内壁コーナー移動（Inner Corner Transition）** 機能を詳細記載（完成度60%） |
| | | - **外壁コーナー移動（Outer Corner Transition）** 機能を追記（完成度65%） |
| | | - 2.4, 2.5 節を新設（各機能の関数・変数・動作フロー詳細） |
| | | - 0.4 節に「高度機能」カテゴリを追加 |
| | | - 動作確認チェックリストを「基本」「高度」に分類 |
| **4.2** | **2026-01-20** | **外壁コーナー機能の一時除外：** |
| | | - **外壁コーナー移動** を現時点で除外（bEnableOuterCorner=false で無効化） |
| | | - 動作確認チェックリストから外壁コーナーを除外 |
| | | - 0.4 節の高度機能テーブルを更新（一時除外を明記） |
| **4.3** | **2026-01-21** | **検証結果を反映：** |
| | | - **BS_Ledge が未作成**であることを発見、計画書全体で修正（新規作成要に変更） |
| | | - **FreeAnimationLibrary**: 102個 → 133個（21カテゴリ）に修正 |
| | | - **FreeSampleAnimationSet**: 38個 → 182個（15カテゴリ）に修正 |
| | | - **AM_ClimbUp_At_Top** のパスを修正（FreeAnimationLibrary/Climbing_Animations/WallGrab_unGrab/内） |
| | | - **FreeAnimationLibrary と FreeSampleAnimationSet を AthleticTrial にコピー完了** |

---

## 10. 参照ドキュメント

### 公式ドキュメント
- [Unreal Engine 5 Animation Retargeting](https://dev.epicgames.com/documentation/en-us/unreal-engine/animation-retargeting-in-unreal-engine)
- [Motion Matching in UE5](https://dev.epicgames.com/documentation/en-us/unreal-engine/pose-search-in-unreal-engine)
- [Game Animation Sample Documentation](https://dev.epicgames.com/documentation/en-us/unreal-engine/game-animation-sample-project-for-unreal-engine)
- [IK Rig Documentation](https://dev.epicgames.com/documentation/en-us/unreal-engine/ik-rig-in-unreal-engine)

### プロジェクト内ドキュメント
- `/Docs/ClimbingSystem_DetailedDesign.md` - AC_Climbing システム設計書
- `/Docs/ClimbingSystem_BugAnalysis_2025-01-05.md` - バグ分析レポート
- `/Docs/ClimbingSystem/Phase3_CharacterIntegration_TODO.md` - 統合TODOリスト

### 関連アセット（AnimationTestProject）- 流用対象

#### コア機能
- `/Game/ThirdPerson/Blueprints/Components/AC_Climbing` - メインコンポーネント（改修後 Migrate）
- `/Game/ThirdPerson/Blueprints/BP_ThirdPersonCharacter` - 参照用（統合パターン確認）

#### Enum
- `/Game/ThirdPerson/Blueprints/Enums/E_ClimbState` - 状態 Enum（直接 Migrate）
- `/Game/ThirdPerson/Blueprints/Enums/E_CornerType` - コーナー種別 Enum（直接 Migrate）

#### BlendSpace
- `/Game/ThirdPerson/Blueprints/BS_Climbing` - 壁クライミング用 BlendSpace 2D（直接 Migrate）
- ~~`/Game/ThirdPerson/Blueprints/BS_Ledge`~~ - **未作成**（新規作成が必要）

#### 入力システム
- `/Game/ThirdPerson/Input/Actions/IA_GrabWall` - 壁吸着 Input Action（E キーにリマップ）
- `/Game/ThirdPerson/Input/Actions/IA_ClimbUp` - 上昇 Input Action（直接 Migrate）
- `/Game/ThirdPerson/Input/Actions/IA_Release` - 解放 Input Action（直接 Migrate）
- `/Game/ThirdPerson/Input/IMC_Climbing` - クライミング用 Input Mapping Context（設定調整）
- `/Game/ThirdPerson/Input/IMC_Default` - デフォルト Input Mapping Context（参照用）

#### アニメーション
- `/Game/FreeAnimationLibrary/` - 133 アニメーション・21カテゴリ（**AthleticTrial にコピー済み**、リターゲット要）
- `/Game/FreeSampleAnimationSet/` - 182 アニメーション・15カテゴリ（**AthleticTrial にコピー済み**、リターゲット要）
- `/Game/FreeAnimationLibrary/Climbing_Animations/WallGrab_unGrab/AM_ClimbUp_At_Top` - レッジ登りモンタージュ（直接 Migrate）

---

**End of Document**
